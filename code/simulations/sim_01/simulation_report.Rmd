---
title: "Orvac Simulation Results"
author: "Mark Jones"
date: "`r Sys.time()`"
output:
  html_document:
    classoption: landscape
    css: style.css
    number_sections: yes
    self_contained: yes
    theme: united
    toc: yes
    toc_float: true
  pdf_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 3
  word_document:
    toc: yes
    toc_depth: '3'
geometry: left=0.2cm,right=0.2cm,top=1cm,bottom=1cm
editor_options:
  chunk_output_type: console
classoption: landscape
---

<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path = 'figs/')
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(kableExtra))
suppressPackageStartupMessages(library(psych))
suppressPackageStartupMessages(library(grid))
suppressPackageStartupMessages(library(gridExtra))
suppressPackageStartupMessages(library(DT))
suppressPackageStartupMessages(library(htmltools))
source("util.R")


getsum <- function(x){
  mysummary <- data.frame(NA_real_, NA_character_, NA_real_, NA_real_,
                NA_real_, NA_real_,  NA_real_,  as.numeric(1),
                mean(x$i_c_mean), mean(x$i_c_sd),  mean(x$i_t_mean),
                mean(x$i_t_sd), mean(x$c_c_mean), mean(x$c_c_sd),
                mean(x$c_c_mean), mean(x$c_c_sd),
                geometric.mean(x$pct_fut), mean(x$ss_fut_mean),
                mean(x$ss_fut_sd), mean(x$ss_fut_med),
                geometric.mean(x$pct_sup), mean(x$ss_sup_mean),
                mean(x$ss_sup_sd),  mean(x$ss_sup_med),
                geometric.mean(x$pct_stopv),  mean(x$ss_stopv_mean),
                mean(x$ss_stopv_sd), mean(x$ss_stopv_med), NA_character_,
                stringsAsFactors = F)
    row.names(mysummary) <- NULL
    names(mysummary) <- names(x)
    mysummary
}


ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text = element_text(size = 10))
ggplot2::theme_update(legend.position = "top")
ggplot2::theme_update(legend.title = element_blank())
ggplot2::theme_update(axis.text.x = element_text(size = 10))
ggplot2::theme_update(axis.text.y = element_text(size = 10))

# Work|Right|Fast
# rmarkdown::render("simulation_report.Rmd", clean=TRUE)
```



# Results from simulation scenarios
***
The following tables and plots summarise the scenarios that were simulated. We use the thresholds as discussed in the "decision rules and thresholds" section towards the end of this report. All scenarios were based on 1000 simulated trials. Filenames that correspond to the results are omitted but are contained in the RDS files associated with this report.

<!-- ### Todo -->

<!-- should report the difference for clin and immu along with the uncertainty/95% percentiles. -->

<!-- introduce a really really high threshold for the posterior decision on immunological (latter will be more palatable) -->

<!-- look up bias and precision - pdt -->

## Reading the tables

From left to right:

+ true seroconversion probabilities (both arms)
+ true median survival time (both arms)
+ accrual -- number of people per 3 month period (i.e. time between interims)
+ information delay for seroconversion results
+ probabilities of trial being declared superior, futile, inconclusive or venous sampling being stopped (number of trials is shown in parentheses)
+ mean (and sd in parentheses) of sample size at the time when trial stopped


```{r, echo = F}
resfiles <- list.files("out", pattern = "*.RDS")

df_all <- data.frame(stringsAsFactors = F)
for(fname in resfiles){
  d1 <- readRDS(file.path(getwd(), "out", fname))
  # d1 <- readRDS(file.path(getwd(), "out", resfiles[1]))
  
  df_res <- as.data.frame(d1$results)
  
  if(apply(df_res, 2, class)[1] == "list"){
     dnam <- names(df_res)
    df_res <- as.data.frame(do.call(cbind, lapply(1:ncol(df_res), function(x) unlist(df_res[,x]))))
    colnames(df_res) <- dnam
  }

  nsim <- d1$cfg$nsims
  # true values for median surv (mnth)
  baseclin <- med_surv(d1$cfg$b0tte)
  trtclin <- med_surv(d1$cfg$b0tte + d1$cfg$b1tte)
  # true values for seroconversion prob
  basesero <- d1$cfg$baselineprobsero
  trtsero <- d1$cfg$trtprobsero
  # accrual
  accrual <- d1$cfg$people_per_interim_period
  info_delay <- d1$cfg$sero_info_delay
  alt_cen <- d1$cfg$use_alt_censoring
  
  outcome_labs <- c("Futile", "Superior", "Inconclusive")
  df_res$trial_outcome <- NA
  df_res$trial_outcome <- ifelse(df_res$stop_i_fut == 1 | df_res$stop_c_fut == 1, 1, df_res$trial_outcome)
  df_res$trial_outcome <- ifelse(df_res$stop_c_sup == 1, 2, df_res$trial_outcome)
  df_res$trial_outcome <- ifelse(df_res$inconclusive == 1, 3, df_res$trial_outcome)
  
  # (dftmp <- df_res[df_res$idxsim == 9,])
  
  df_res$trial_outcome <- factor(df_res$trial_outcome, levels = 1:3, labels = outcome_labs)

  # df_res$trial_outcome <- ifelse(stop_v_samp == 1, 3, df_res$trial_outcome)

  # trials are either futile or superior 
  df_outcome <- df_res %>%
    dplyr::filter(trial_outcome %in% c("Futile", "Superior", "Inconclusive") )
    
  df_stopv <- df_res %>%
    dplyr::filter(stop_v_samp == 1) 
  
  n <- c(table(df_res$trial_outcome),   nrow(df_stopv))
  names(n) <- c("Futile","Superior","Inconclusive", "StopV"    )
  prob <- c(prop.table(table(df_res$trial_outcome)),   nrow(df_stopv)/max(df_res$idxsim))
  names(prob) <- c(names(prob)[1:3], "StopV")
  
  df_ss <- df_outcome %>% 
    dplyr::group_by(trial_outcome) %>%
    dplyr::summarise(ss_mean = mean(n_obs), 
                     ss_sd = sd(n_obs)) %>%
    tidyr::complete(trial_outcome, fill = list(ss_mean = 0))
  
  

  dtmp <- data.frame(idsim = d1$cfg$idsim,
                     nsim = nsim,

                     basesero = basesero,
                     trtsero = trtsero,
                     baseclin = baseclin,
                     trtclin = trtclin,
                     accrual = accrual,
                     info_delay = info_delay,
                     
                     prob_sup = prob["Superior"],
                     prob_fut = prob["Futile"],
                     prob_incon = prob["Inconclusive"],
                     prob_stopv = prob["StopV"],
                     
                     n_sup = n["Superior"],
                     n_fut = n["Futile"],
                     n_incon = n["Inconclusive"],
                     n_stopv = n["StopV"],
                                         
                     ss_fut_mean = unlist(df_ss[df_ss$trial_outcome == "Futile", "ss_mean"]), 
                     ss_fut_sd = unlist(df_ss[df_ss$trial_outcome == "Futile", "ss_sd"]), 
                     
                     ss_sup_mean = unlist(df_ss[df_ss$trial_outcome == "Superior", "ss_mean"]), 
                     ss_sup_sd = unlist(df_ss[df_ss$trial_outcome == "Superior", "ss_sd"]), 
                    
                     ss_incon_mean = unlist(df_ss[df_ss$trial_outcome == "Inconclusive", "ss_mean"]), 
                     ss_incon_sd = unlist(df_ss[df_ss$trial_outcome == "Inconclusive", "ss_sd"]), 
                     
                     ss_stopv_mean = mean(df_stopv$n_obs),
                     ss_stopv_sd = sd(df_stopv$n_obs),

                     fname = fname, stringsAsFactors = F, 
                     alt_cen = alt_cen)
  
  dtmp <- dtmp %>%
    dplyr::mutate(f_prob_sup = sprintf("%.3f (%d)", prob_sup, n_sup),
                  f_prob_fut = sprintf("%.3f (%d)", prob_fut, n_fut),
                  f_prob_incon = sprintf("%.3f (%d)", prob_incon, n_incon),
                  f_prob_stopv = sprintf("%.3f (%d)", prob_stopv, n_stopv),
                  
                  f_ss_sup = sprintf("%.0f (%.1f)", ss_sup_mean, ss_sup_sd),
                  f_ss_fut = sprintf("%.0f (%.1f)", ss_fut_mean, ss_fut_sd),
                  f_ss_incon = sprintf("%.0f (%.1f)", ss_incon_mean, ss_incon_sd),
                  f_ss_stopv = sprintf("%.0f (%.1f)", ss_stopv_mean, ss_stopv_sd) )

  df_all <- rbind(df_all,  dtmp, stringsAsFactors  = F)

}

# df_tmp <- df_all %>%
#   dplyr::filter(idsim == "ClinSeroTrt03") 

# mean(df_tmp$ss_fut_mean)

# unique(df_all$idsim)
df_0 <- df_all %>%
  dplyr::arrange(-accrual, baseclin, basesero) %>%
  dplyr::mutate(row = 1:n()) %>%
  dplyr::select(row, nsim, 
                basesero, trtsero, baseclin, trtclin, accrual,info_delay,
                f_prob_sup, f_prob_fut, f_prob_incon, f_prob_stopv, 
                f_ss_sup, f_ss_fut, f_ss_incon, f_ss_stopv,
                fname, idsim, alt_cen) %>%
  dplyr::select(-row)

df_blank <- df_0 %>% dplyr::slice(1L) 


# Null01 SeroTrt01 ClinTrt01 ClinTrt02 ClinSeroTrt01 ClinSeroTrt02 ClinSeroTrt03 ClinSeroTrt04

# df_0 %>%
#   dplyr::select(nsim, idsim, fname) %>%
#   dplyr::arrange(idsim, fname)

digits <- c(2, 2, 0, 0, 0, 2,
            0, 0, 0, 0,
            0, 0, 0, 0)
options(knitr.kable.NA = '-')
```

```{r, echo = F, eval = F}
datatable(df_0, options = list(pageLength = 100, autoWidth = TRUE,  columnDefs = list(list(width = '600px', targets = 16))), rownames = FALSE, filter = 'top')

```


## Null Scenarios

### No immunological effect, no time to event effect

Trials are indicated as futile > 95% of the time with a type i error < 0.05.

Average sample size at which futility is announced is 150. Venous sampling is stopped less than 5% of the time, but this needs to be considered in the context of the fact that most trials are already identified as futile.



```{r, echo = F, eval = T}

#stopifnot(nrow(df_0) == 24)
# Null01 SeroTrt01 ClinTrt01 ClinTrt02 ClinSeroTrt01 ClinSeroTrt02 ClinSeroTrt03 ClinSeroTrt04

currentsimid <- "Null01"
if(sum(df_0$idsim == currentsimid ) > 0) {

  kable(df_0 %>% dplyr::filter(idsim == currentsimid) %>% dplyr::select(-fname, -idsim, -nsim, -alt_cen) %>%
        dplyr::arrange(basesero, baseclin, -accrual, info_delay),
      caption = "Table 1. Simulation Null Scenarios",
      col.names = c("base", "trt", "base", "trt", "accrual", "info delay",
                    "superiority", "futility", "inconclusive", "stop v samp",
                    "superiority", "futility", "inconclusive", "stop v samp"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11,
                latex_options = "hold_position") %>%
  add_header_above(c("Seroconversion" = 2, "Clinical" = 2,
                     " " = 1, " " = 1,
                     "Probability (number of trials)" = 4,
                     "Mean sample size (sd)" = 4))
}



```



## Immunological effect scenarios

### Small immunological effect, no time to event effect

Table 2 shows the results from simulating with a 25% increase in seroconversion rates and no difference across the arms in the clinical endpoint. Accrual at both 30 and 50 over the 3 month period. Information delay for seroconversion results is two-weeks.

Futility remains high (mean of 0.9) because superiority can only be determined based on the clinical endpoint. Mean/median type i error are both around 0.08. Venous sampling is more likely to be stopped but, again, most of the trials are deemed futile. Average sample size for declaring futility is approximately 298, i.e. is higher than the null case above. Approximately 1.5% of trials were inconclusive.

```{r, echo = F}
currentsimid <- "SeroTrt01"
if(sum(df_0$idsim == currentsimid ) > 0) {

# Null01 SeroTrt01 ClinTrt01 ClinTrt02 ClinSeroTrt01 ClinSeroTrt02 ClinSeroTrt03 ClinSeroTrt04
kable(df_0 %>% dplyr::filter(idsim == currentsimid) %>% dplyr::select(-fname, -idsim, -nsim, -alt_cen) %>%
        dplyr::arrange(basesero, trtsero),
      caption = "Table 2. Immunological effect scenario 1",
      col.names = c("base", "trt", "base", "trt", "accrual", "info delay",
                    "superiority", "futility", "inconclusive", "stop v samp",
                    "superiority", "futility", "inconclusive", "stop v samp"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11,
                latex_options = "hold_position") %>%
  add_header_above(c("Seroconversion" = 2, "Clinical" = 2,
                     " " = 1, " " = 1,
                     "Probability (number of trials)" = 4,
                     "Mean sample size (sd)" = 4))
}

```




## Clinical effect scenarios

### No immunological effect, small time to event effect

Table 3 shows the results from simulating zero difference in seroconversion rate. Median survival time is assumed to increase by 5 months. Accrual rates are 30 and 50 over the 3 month period. Information delay for seroconversion results is two-weeks.

Futility decision is still very likely (mean probability of futility equals 0.93) and power is very low (6%). Venous sampling is unlikely to be stopped. Average sample size for declaring futility is approximately 135.

```{r, echo = F, eval = T}

currentsimid <- "ClinTrt01"
if(sum(df_0$idsim == currentsimid ) > 0) {

# Null01 SeroTrt01 ClinTrt01 ClinTrt02 ClinSeroTrt01 ClinSeroTrt02 ClinSeroTrt03 ClinSeroTrt04
kable(df_0 %>% dplyr::filter(idsim == currentsimid) %>% dplyr::select(-fname, -idsim, -nsim, -alt_cen) %>%
        dplyr::arrange(baseclin, trtclin),
      caption = "Table 3. Clinical Scenario",
      col.names = c("base", "trt", "base", "trt", "accrual", "info delay",
                    "superiority", "futility", "inconclusive", "stop v samp",
                    "superiority", "futility", "inconclusive", "stop v samp"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11,
                latex_options = "hold_position") %>%
  add_header_above(c("Seroconversion" = 2, "Clinical" = 2,
                     " " = 1, " " = 1,
                     "Probability (number of trials)" = 4,
                     "Mean sample size (sd)" = 4))
}
```


### No immunological effect, large time to event effect

Table 4 shows the results from simulating zero difference in seroconversion rates. Median survival time is assumed to increase by 9 months. Accrual is 30 and 50 over the 3 month period. Information delay for seroconversion results is two-weeks.

Futility decision is still very likely (mean probability of futility equals 0.9) and power is very low (mean is 9%). Again, venous sampling is unlikely to be stopped. Average sample size for declaring futility is approximately 135.

```{r, echo = F, eval = T}


currentsimid <- "ClinTrt02"
if(sum(df_0$idsim == currentsimid ) > 0) {

# Null01 SeroTrt01 ClinTrt01 ClinTrt02 ClinSeroTrt01 ClinSeroTrt02 ClinSeroTrt03 ClinSeroTrt04
kable(df_0 %>% dplyr::filter(idsim == currentsimid) %>% dplyr::select(-fname, -idsim, -nsim, -alt_cen) %>%
        dplyr::arrange(baseclin, trtclin),
      caption = "Table 4. Clinical Scenario",
      col.names = c("base", "trt", "base", "trt", "accrual", "info delay",
                    "superiority", "futility", "inconclusive", "stop v samp",
                    "superiority", "futility", "inconclusive", "stop v samp"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11,
                latex_options = "hold_position") %>%
  add_header_above(c("Seroconversion" = 2, "Clinical" = 2,
                     " " = 1, " " = 1,
                     "Probability (number of trials)" = 4,
                     "Mean sample size (sd)" = 4))
  
} 


```


## Combined effect scenarios

### Small immunological effect, small time to event effect

Table 5 shows the results from simulating a 25% increase in probability of seroconversion in the treatment arm. Median survival time is assumed to increase by 5 months. Accrual rates are 30 and 50 over the 3 month period. Information delay for seroconversion results is two-weeks.

Power has increased but is still low (26%). Probability of a futile outcome is around 0.7. Mean sample size to declare superiority is 520, whereas futility is declared around ss of 281. Venous sampling is stopped more often than earlier scenarios with a mean probability of stopping equal to 0.37. Around 4% of trials are inconclusive.

```{r, echo = F, eval = T}
# Null01 SeroTrt01 ClinTrt01 ClinTrt02 ClinSeroTrt01 ClinSeroTrt02 ClinSeroTrt03 ClinSeroTrt04

currentsimid <- "ClinSeroTrt01"
if(sum(df_0$idsim == currentsimid ) > 0) {

kable(df_0 %>% dplyr::filter(idsim == currentsimid) %>% dplyr::select(-fname, -idsim, -nsim, -alt_cen) %>%
        dplyr::arrange(basesero, trtsero, baseclin, trtclin),
      caption = "Table 5. Combined Scenario",
      col.names = c("base", "trt", "base", "trt", "accrual", "info delay",
                    "superiority", "futility", "inconclusive", "stop v samp",
                    "superiority", "futility", "inconclusive", "stop v samp"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11,
                latex_options = "hold_position") %>%
  add_header_above(c("Seroconversion" = 2, "Clinical" = 2,
                     " " = 1, " " = 1,
                     "Probability (number of trials)" = 4,
                     "Mean sample size (sd)" = 4))
}
```


### Large immunological effect, small time to event effect

Table 6 shows the results from simulating a 45% increase in probability of seroconversion in the treatment arm. Median survival time is assumed to increase by 5 months. Accrual rates are 30 and 50 over the 3 month period. Information delay for seroconversion results is two-weeks.

Power has increased again but is still low (40%). Probability of a futile outcome is around 0.5. Mean sample size to declare superiority is 532, whereas futility is declared around ss of 419. Venous sampling is very likely to be stopped (mean probability of stopping 0.73). Around 7% of trials are inconclusive.


```{r, echo = F, eval = T}
# Null01 SeroTrt01 ClinTrt01 ClinTrt02 ClinSeroTrt01 ClinSeroTrt02 ClinSeroTrt03 ClinSeroTrt04

currentsimid <- "ClinSeroTrt02"
if(sum(df_0$idsim == currentsimid ) > 0) {
  
  kable(df_0 %>% dplyr::filter(idsim == "ClinSeroTrt02") %>% dplyr::select(-fname, -idsim, -nsim, -alt_cen) %>%
        dplyr::arrange(basesero, trtsero, baseclin, trtclin),
      caption = "Table 6. Combined Scenario",
      col.names = c("base", "trt", "base", "trt", "accrual", "info delay",
                    "superiority", "futility", "inconclusive", "stop v samp",
                    "superiority", "futility", "inconclusive", "stop v samp"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11,
                latex_options = "hold_position") %>%
  add_header_above(c("Seroconversion" = 2, "Clinical" = 2,
                     " " = 1, " " = 1,
                     "Probability (number of trials)" = 4,
                     "Mean sample size (sd)" = 4))
  
}

# df_tmp <- df_all %>%
#   dplyr::arrange(-accrual, baseclin, basesero) %>%
#   dplyr::mutate(row = 1:n()) %>%
#   dplyr::filter(idsim == "ClinSeroTrt02") 
# 
# mean(df_tmp$prob_sup)
```

### Small immunological effect, large time to event effect

Table 7 shows the results from simulating a 25% increase in probability of seroconversion in the treatment arm. Median survival time is assumed to increase by 9 months. Accrual rates are 30 and 50 over the 3 month period. Information delay for seroconversion results is two-weeks.

Power is still low (42%). Probability of a futile outcome is around 0.55. Mean sample size to declare superiority is 505, whereas futility is declared around ss of 207 Venous sampling is very likely to be stopped (mean probability of stopping 0.36). Around 4% of trials are inconclusive.

```{r, echo = F, eval = T}
# Null01 SeroTrt01 ClinTrt01 ClinTrt02 ClinSeroTrt01 ClinSeroTrt02 ClinSeroTrt03 ClinSeroTrt04

currentsimid <- "ClinSeroTrt03"
if(sum(df_0$idsim == currentsimid ) > 0) {

kable(df_0 %>% dplyr::filter(idsim == currentsimid) %>% dplyr::select(-fname, -idsim, -nsim, -alt_cen) %>%
        dplyr::arrange(basesero, trtsero, baseclin, trtclin),
      caption = "Table 7. Combined Scenario",
      col.names = c("base", "trt", "base", "trt", "accrual", "info delay",
                    "superiority", "futility", "inconclusive", "stop v samp",
                    "superiority", "futility", "inconclusive", "stop v samp"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11,
                latex_options = "hold_position") %>%
  add_header_above(c("Seroconversion" = 2, "Clinical" = 2,
                     " " = 1, " " = 1,
                     "Probability (number of trials)" = 4,
                     "Mean sample size (sd)" = 4))
}
```

### Large immunological effect, large time to event effect

Table 8 shows the results from simulating a 45% increase in probability of seroconversion in the treatment arm. Median survival time is assumed to increase by 9 months. Accrual rates are 30 and 50 over the 3 month period. Information delay for seroconversion results is two-weeks.

Power now reaches around 82%. Probability of a futile outcome is around 0.17. Mean sample size to declare superiority is 390, whereas futility is declared around ss of 183 Venous sampling is very likely to be stopped (mean probability of stopping 0.73). Around 1% of trials are inconclusive.

```{r, echo = F, eval = T}
# Null01 SeroTrt01 ClinTrt01 ClinTrt02 ClinSeroTrt01 ClinSeroTrt02 ClinSeroTrt03 ClinSeroTrt04

currentsimid <- "ClinSeroTrt04"
if(sum(df_0$idsim == currentsimid ) > 0) {

kable(df_0 %>% dplyr::filter(idsim == currentsimid & alt_cen == 0) %>% dplyr::select(-fname, -idsim, -nsim, -alt_cen) %>%
        dplyr::arrange(basesero, trtsero, baseclin, trtclin),
      caption = "Table 8a. Combined Scenario - std cen",
      col.names = c("base", "trt", "base", "trt", "accrual", "info delay",
                    "superiority", "futility", "inconclusive", "stop v samp",
                    "superiority", "futility", "inconclusive", "stop v samp"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11,
                latex_options = "hold_position") %>%
  add_header_above(c("Seroconversion" = 2, "Clinical" = 2,
                     " " = 1, " " = 1,
                     "Probability (number of trials)" = 4,
                     "Mean sample size (sd)" = 4))
}
```


```{r, echo = F, eval = T}
# Null01 SeroTrt01 ClinTrt01 ClinTrt02 ClinSeroTrt01 ClinSeroTrt02 ClinSeroTrt03 ClinSeroTrt04

currentsimid <- "ClinSeroTrt04"
if(sum(df_0$idsim == currentsimid ) > 0) {

kable(df_0 %>% dplyr::filter(idsim == currentsimid & alt_cen == 1) %>% dplyr::select(-fname, -idsim, -nsim, -alt_cen) %>%
        dplyr::arrange(basesero, trtsero, baseclin, trtclin),
      caption = "Table 8a. Combined Scenario - alt cen",
      col.names = c("base", "trt", "base", "trt", "accrual", "info delay",
                    "superiority", "futility", "inconclusive", "stop v samp",
                    "superiority", "futility", "inconclusive", "stop v samp"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11,
                latex_options = "hold_position") %>%
  add_header_above(c("Seroconversion" = 2, "Clinical" = 2,
                     " " = 1, " " = 1,
                     "Probability (number of trials)" = 4,
                     "Mean sample size (sd)" = 4))
}
```


# Conclusions
***
1. In the null scenarios the type i error appears to be well controlled. If anything, there is scope to make the decision thresholds less conservative.
1. When there is only a seroconversion effect, the trial is likely to be indicated as futile. This is also true when the clinical endpoint is the only one in which we see an effect. This is because the futility decision is made when either the immunological or clinical endpoint show no effect.
1. While power increases as the twin effects increase, we only see 80%+ power when both the seroconversion and clinical effects are large (45% increase and 9 month increase respectively). Even in this scenario, the probability of a futile decision is still moderately high (0.17). 


```{r, echo = F, eval = F, fig.height=8, fig.width=12}
df_tmp <- df_clinsero1
df_tmp$accrual <- as.factor(df_tmp$accrual)
p1 <- ggplot(df_tmp, aes(x = baseclin, y = 100*pct_fut,
                         colour = accrual))+
              geom_point() +
  geom_line() +
  scale_colour_discrete(name = "Accrual per interim") +
  scale_x_continuous("Control arm median time to event") +
  scale_y_continuous("% futility", limits = c(0, 75)) +
  facet_grid(paste0("seroconversion control ", basesero) ~ paste0("sero trt ", trtsero))+
  theme(legend.position="top")

p2 <- ggplot(df_tmp, aes(x = baseclin, y = 100*pct_sup, colour = accrual))+
              geom_point() +
  geom_line() +
  scale_colour_discrete(name = "Accrual per interim") +
  scale_x_continuous("Control arm median time to event") +
  scale_y_continuous("% superiority", limits = c(25, 100)) +
  facet_grid(paste0("seroconversion control ", basesero) ~ paste0("sero trt ", trtsero))+
  theme(legend.position="top")

p3 <- ggplot(df_tmp, aes(x = baseclin, y = 100*pct_stopv, colour = accrual))+
              geom_point() +
  geom_line() +
  scale_colour_discrete(name = "Accrual per interim") +
  scale_x_continuous("Control arm median time to event") +
  scale_y_continuous("% cease venous", limits = c(50, 100)) +
  facet_grid(paste0("seroconversion control ", basesero) ~ paste0("sero trt ", trtsero))+
  theme(legend.position="top")

# gridExtra::grid.arrange(p1, p2, p3, ncol = 3,
#              top = grid::textGrob("Figure 1. Power as a function of simulation params",
#                             x = 0, y = 0.5,
#                             just = "left",
#                             gp = grid::gpar(fontsize = 12)))
```

# Data generation processes
***
We simulate 1000 trials by generating data as follows:

+ equal numbers of participants in the control and treatment arms accrued sequentially (treatment, control, treatment, control...etc)
+ age of participants based on a truncated normal distribution with the lower and upper bounds set to 6 and 12 months, a mean of 6.5 months and a standard deviation of 1 month (the age is used to assess censoring in the time to event analyses - we follow participants until 36 months)
+ accrual time (time of randomisation) is set sequentially for each participant. Specifically, the accrual times for participants $1, 2, 3, \dots, n$ are set to $0, t, 2t, 3t, \dots, (n-1)t$ where $t$ is the time required to accrue a single participant
+ for each participant, baseline seroconversion status is generated as a bernoulli random draw parameterised with $p$ equal to the baseline seroconversion probability
+ seroconversion status after the third dose/placebo is generated in the same fashion conditional on treatment status, baseline seroconversion status and treatment arm probability of seroconversion
+ time to event times are generated as draws from an exponential distribtion with rate parameter set conditional on treatment group status. Censoring occurs due to age at interim and events that are unobserved at the current interim time.
+ interim analyses are done on the basis of predictive probability
+ final analyses are complete after follow up. For the time to event analysis this means waiting until the youngest participant at the end of the enrollment period is 36 months old. For the immunological analysis this means we wait until all seroconversion results are obtained.

# Accrual rates
***
The word on the ground is that 50 per three month period is not realistic. The accrual rate is likely to be blocky due to seasonal effects and the effects of visits to remote communities where several kids might be accrued on the same day. Additionally, there is the possibility of additional sites coming on line. While Katherine is probably no longer an option, Alice may come on line around July 2019. Conservatively Alice may add 40 participants per year. At the moment the 2019 intake target is about 120 (in 2018 around 60 were enrolled). Urban recruitment remains very slow.

# Seroconversion modelling
***
The seroconversion model uses a beta conjugate prior to the bernoulli likelihood. The prior is uniform, i.e. $Beta(1, 1)$, i.e. uninformative. We model an information delay such that, at any given interim, some individuals will have been randomised and treated but seroconversion will still be pending. 

On the basis the seroconversions in each arm and the number of observed individuals at the interim, we compute the posterior distribution for the parameter of interest (probability of a successful trial, $p$). We do this for the control and treatment arms independently, yielding posteriors for $p_{trt}$ and $p_{ctl}$. We impute the participants for whom seroconversion results are pending and combine with the observed data. On the basis of this data we compute the probability of success. If this is greater than the nominated threshold then we claim success and cease further venous sampling. When repeated multiple times on the imputed datasets we obtain a predictive probability of success.

To assess futility, we repeat the equivalent process but impute to the maximum number of seroconversion samples. However, for futility, we compare the proportion of successful trial with a futility threshold, say 5% (see below). If the proportion of successful trials is less than this threshold, we say the trial is futile and cease enrollment.

The final analysis assumes that we have waited until we have all the seroconversion results and then computes the posterior for the difference between the control and treatment arms.

Note - we stop venous sampling at 250 participants.

# Medical attendance modelling
***
Note - we do not start modelling medical attendance until we have at least 150 participants. If we start the time to event analyses from 50 then we are going to get ridiculous results because we will see no events.

The approach is similar to the one adopted for modelling seroconversion. Obviously the modelling assumptions are somewhat different and censoring is also involved.

At each interim we have an increasing number of participants. Each will have been accrued at a certain time and will have an age somewhere between 6 and 12 months at the time of accrual/ranomdisation. Knowing the month of the interim, the accrual time and the age at which they were accrued, we can compute the age at the current interim. If the sum of a participants age and their time to event (see later) is in excess of 36 months (max. follow up time) they are censored with censoring time equal to 36 months. Additionally, if the sum of a participants time to event and the accrual time is in excess of the interim then they are censored. The censoring time is the minimum of the 36 months and the difference between the current interim and the time of accrual.

The time to event model uses a gamma conjugate prior to the exponential likelihood and essentially everything is as per the seroconversion model. We compute the posterior for the parameter of interest (a rate parameter $\gamma$ to the exponential distribution) and generate imputed datasets for the participants that were yet to be observed up to the maximum sample size.

# Decision rules and thresholds
***
The key points are that (1) the trial may be stopped due to futility based on an assessment of either endpoint (2) the trial may be stopped for superiority only on the basis of the clinical endpoint and (3) venous sampling can be stopped based on an assessment of the immunological endpoint.

+ To declare superiority in the immunological endpoint (and cease venous sampling but continue enrolling for the clinical endpoint) we require $\frac{1}{k}\sum_{i=1}^{n_{post}}I(Pr(\delta_{interim} >0)>0.975) > 0.975$ where $n_{post}$ is the number of posterior draws used in imputing the pending observations, $\delta_{interim} = p_{trt} - p_{ctl}$ is the difference between the probability of seroconversion in the treatment and control arms calculated using the observed and imputed seroconversions results to the time of the interim analysis.

+ To declare futility in the immunological endpoint we require $\frac{1}{k}\sum_{i=1}^{n_{post}}I(Pr(\delta_{max n} >0)>0.975) < 0.05$. In other words, if less than 5% of our simulated datasets result in a successful trial we declare futility.

+ To declare superiority in the clinical endpoint (and therefore in the trial) we require $Pr(\gamma >0) > 0.975$ where $\gamma = t_{trt} / t_{ctl}$, where $t$ is the median survival time. In other words, if gamma is the ratio in the median survival times then we require that the probability that this difference is in excess of zero be greater than 0.975.

+ To declare futility in the clinical endpoint require $\frac{1}{k}\sum_{i=1}^{n_{post}}I(Pr(\gamma >0)>0.975) < 0.05$. In other words, if less than 5% of our simulated datasets result in a successful trial we declare futility.

# Nuance/Limitations
***
The number of individuals is constrained to a maximum of 1000. We assume that funds are available to continue the experiment up to this point regardless of the accrual rate. However, this may not be realistic.

Based on the above rules we can claim superiority in the immunological endpoint, cease venous sampling, but continue enrolling for the clinical endpoint. However, it is possible for the trial to still be inconclusive or futile on the basis of the clinical results.

Delays in information (i.e. in obtaining the blood results) are implemented.

The type i and type ii errors need to be balanced. We might be unwilling to risk incorrectly rejecting the null hypothesis at the 5% significance level. However, decreasing the type i error implicitly increases the type ii error (and therefore reduces power) when the alternative hypothesis is true. If the type i error is really low and the power is not quite where we want it to be then we can trade these two thresholds off against one another to try and improve the overall operating characteristics.

The models are based on conjugate priors -- I tried many other methods, including writing samplers in C++ and approximations. In the actual analysis we will use generalised linear models (logistic regression) and piecewise exponential survival models both estimated with MCMC. These models will likely include additional covariates but the decision process will remain the same. 

See the SAP/Protocol for further details.

