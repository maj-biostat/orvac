---
title: "Simulation Results"
output:
  html_document:
    toc: true
    theme: united
    classoption: landscape
editor_options:
  chunk_output_type: console
---

<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(kableExtra))
suppressPackageStartupMessages(library(psych))
suppressPackageStartupMessages(library(grid))
suppressPackageStartupMessages(library(gridExtra))
source("util.R")


getsum <- function(x){
  mysummary <- data.frame(NA_real_, NA_character_, NA_real_, NA_real_,
                NA_real_, NA_real_,  NA_real_,  as.numeric(1),
                mean(x$i_c_mean), mean(x$i_c_sd),  mean(x$i_t_mean),
                mean(x$i_t_sd), mean(x$c_c_mean), mean(x$c_c_sd),
                mean(x$c_c_mean), mean(x$c_c_sd),
                geometric.mean(x$pct_fut), mean(x$ss_fut_mean),
                mean(x$ss_fut_sd), mean(x$ss_fut_med),
                geometric.mean(x$pct_sup), mean(x$ss_sup_mean),
                mean(x$ss_sup_sd),  mean(x$ss_sup_med),
                geometric.mean(x$pct_stopv),  mean(x$ss_stopv_mean),
                mean(x$ss_stopv_sd), mean(x$ss_stopv_med), NA_character_,
                stringsAsFactors = F)
    row.names(mysummary) <- NULL
    names(mysummary) <- names(x)
    mysummary
}


ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text = element_text(size = 10))
ggplot2::theme_update(axis.text.x = element_text(size = 10))
ggplot2::theme_update(axis.text.y = element_text(size = 10))


# rmarkdown::render("simulation_report.Rmd", clean=TRUE)
```



## Data generation processes

We simulate 1000 trial by generating data as follows:

+ equal numbers of participants in the control and treatment arms accrued sequentially (treatment, control, treatment, control...etc)
+ age of participants based on a truncated normal distribution with the lower and upper bounds set to 6 and 12 respectively with a mean of 6.5 months and a standard deviation of 1 month (used to assess censoring in the time to event analyses)
+ accrual time (time of randomisation) is set sequentially for each participant. Specifically the accrual times for participants $1, 2, 3, \dots, n$ are set to $0, t, 2t, 3t, \dots, nt$ where $t$ is the time required to accrue a participant
+ for each individual, baseline seroconversion status is generated as a bernoulli random draw parameterised with $p$ equal to the baseline seroconversion probability and $n$ is the $n^{th}$ participant
+ seroconversion status after the third dose/placebo is generated in the same fashion conditional on treatment status, baseline seroconversion status and treatment arm probability of seroconversion
+ time to event times are generated as draws from an exponential distribtion with rate parameter set conditional on treatment group status. Censoring occurs due to age at interim and events that are unobserved at the current interim time.

## Seroconversion modelling

The seroconversion model uses a beta conjugate prior to the bernoulli likelihood. The prior is uniform, i.e. $Beta(1, 1)$, i.e. uninformative. On the basis of the number of seroconversions in each arm and the number of observed individuals at the interim, we compute the posterior distribution for the parameter of interest (probability of a successful trial, $p$). We do this for the control and treatment arms independently, yielding posteriors for $p_{trt}$ and $p_{ctl}$. The difference between these two is approximately normal so we could assess the difference on that basis. However, instead we just look at the proportion of times (out of our posterior draws) that the difference between the two posterior draws is greater than zero. This proportion is an empirical probability and if it is in excess of the some nominated threshold (see section thresholds below) we claim that the immunological endpoint is successful and cease further venous sampling.

Now, we have a posterior for $p_{ij}$ $i = 1..n_{post}$ where $n_{post}$ is number of posterior draws we sampled and $j = 0, 1$ is an indicator of treatment group. Thus, we can impute the currently unobserved results for seroconversion up to the maximum possible number of venous samples. We can do this directly from a beta-binomial distribution, or, we can iterate through the posterior draws $p_i$ and generate random draws from a bernoulli distribution parameterised with our current value of $p$. We do the latter making as many simulated data sets as we wish.

Next, assuming we have generated $n$ data sets corresponding to the combination of currently observed values for seroconversion status and those that we imputed, we can (once again) compute the posterior of our paramater of interest in each case. Again, we can look at the posterior of the parameter of interest and again we can deterime an empirical probability that it is in excess of some nominated threshold. We do this for ALL $n$ of the imputed datasets. The proportion of these in which a successful trial was observed is compared to a futility threshold, say 5% (see below). If the proportion of successful trials is less than this threshold, we say the trial is futile and cease enrollment.

Note - we stop venous sampling at 250 participants.

## Medical attendance modelling

Note - we do not start modelling medical attendance until we have 250 participants. If we start this from 50 then we are going to get ridiculous results because we will see no events.

Conceptually, the approach is similar to the one adopted for modelling seroconversion. Obviously the modelling assumptions are somewhat different and censoring is also involved. Let's talk about censoring first.

At each interim we have an increasing number of participants. Each will have been accrued at a certain time and will have an age somewhere between 6 and 12 months at the time of accrual/ranomdisation. Knowing the month of the interim, the accrual time and the age at which they were accrued, we can compute the age at the current interim. If the sum of a participants age and their time to event (see later) is in excess of 36 months (max. follow up time) they are censored with censoring time equal to 36 months. Additionally, if the sum of a participants time to event and the accrual time is in excess of the interim then they are censored. The censoring time is the minimum of the 36 months and the difference between the current interim and the time of accrual.

The time to event model uses a gamma conjugate prior to the exponential likelihood and essentially everything is as per the seroconversion model. We compute the posterior for the parameter of interest (a rate parameter $\gamma$ to the exponential distribution) and generate imputed datasets for the participants that were yet to be observed up to the maximum sample size. For superiority we examine the ratio of the rate parameters which is proportional to the ratio of median survival time and compare this ratio to 1. For futility we do the equivalent, but on numerous hypothetical data we generated based on our current knowledge of the posterior.

## Decision rules and thresholds

+ To declare superiority in the immunological endpoint (and cease venous sampling but continue enrolling for the clinical endpoint) we require $Pr(\delta >0) > 0.975$ where $\delta = p_{trt} - p_{ctl}$. If delta is the distribution of the differences between the proportions in each arm, then we require that the probability that the difference is in excess of zero be greater than 0.975.

+ To declare futility in the immunological endpoint we require $\frac{1}{k}\sum_{i=1}^{n_{post}}I(Pr(\delta >0)>0.975) < 0.05$. In other words, if less than 5% of our simulated datasets result in a successful trial we declare futility.

+ To declare superiority in the clinical endpoint (and therefore in the trial) we require $Pr(\delta >0) > 0.975$ where $\delta = p_{trt} - p_{ctl}$. In other words, if delta is the difference in the proportion of seroconverted participants. Then we require that the probability that this difference is in excess of zero be greater than 0.975.

+ To declare futility in the clinical endpoint require $\frac{1}{k}\sum_{i=1}^{n_{post}}I(Pr(\delta >0)>0.975) < 0.05$. In other words, if less than 5% of our simulated datasets result in a successful trial we declare futility.

## Nuance/Limitations

The number of individuals is constrained to a maximum of 1000. We assume that funds are available to continue the experiment up to this point regardless of the accrual rate. However, this may not be realistic.

Based on the above rules we can claim superiority in the immunological endpoint, cease venous sampling, but continue enrolling for the clinical endpoint. Therefore we can conceivably conclude futility in the clinical endpoint in the same simulated trial. This may or may not be desirable.

Delays in information (i.e. in obtaining the blood results) are not currenly implemented.

The models are based on conjugate priors -- I tried many other ways, including writing samplers in C++ and approximations. In the actual analysis we will use generalised linear models (logistic regression) and piecewise exponential survival models both estimated with MCMC. These models will likely include additional covariates but the decision process will remain the same. I am worried that the necessary simulations (i.e. for the real analyses) will take way to long, but will cross that bridge when we come to it. See the SAP for further detail.

## Results from simulation scenarios

The following tables and plots summarise the scenarios that were simulated. We use the thresholds mentioned above.

```{r, echo = F}
resfiles <- list.files("out", pattern = "*.RDS")

df_all <- data.frame(stringsAsFactors = F)
for(fname in resfiles){
  d1 <- readRDS(file.path(getwd(), "out", fname))
  # d1 <- readRDS(file.path(getwd(), "out", "results-2019-01-12-00-43.RDS"))
  df_res <- as.data.frame(d1$results)

  nsim <- d1$cfg$nsims

  # median surv mnth
  baseclin <- med_surv(d1$cfg$b0tte)
  trtclin <- med_surv(d1$cfg$b0tte + d1$cfg$b1tte)

  # sero probs
  basesero <- d1$cfg$baselineprobsero
  trtsero <- d1$cfg$trtprobsero

  # accrual
  accrual <- d1$cfg$people_per_interim_period

  # this is the pct futility just due to sero tests
  df_tmp <- df_res %>%
    dplyr::filter(stop_i_fut == 1 ) %>%
    dplyr::mutate(fut = stop_i_fut)
  pct_fut_i <- nrow(df_tmp)/max(df_res$idxsim)
  # futility due to either
  df_tmp <- df_res %>%
    dplyr::filter(stop_i_fut == 1 | stop_c_fut == 1) %>%
    dplyr::mutate(fut = stop_i_fut + stop_c_fut)
  pct_fut <- nrow(df_tmp)/max(df_res$idxsim)
  
  # ss_fut
  ss_fut_stats <- df_tmp %>%
    dplyr::summarise(mean = mean(n_obs), sd = sd(n_obs), med = median(n_obs))

  # superiority
  df_tmp <- df_res %>%
    dplyr::filter(stop_c_sup == 1)
  pct_sup <- nrow(df_tmp)/max(df_res$idxsim)

  # ss_sup
  ss_sup_stats <- df_tmp %>%
    dplyr::summarise(mean = mean(n_obs), sd = sd(n_obs), med = median(n_obs))

  # stop venous sampling
  df_tmp <- df_res %>%
    dplyr::filter(stop_v_samp == 1)
  pct_stopv <- nrow(df_tmp)/max(df_res$idxsim)

  # ss_stopv
  ss_stopv_stats <- df_tmp %>%
    dplyr::summarise(mean = mean(n_obs), sd = sd(n_obs), med = median(n_obs))

  dtmp <- data.frame(idsim = d1$cfg$idsim,
                                          nsim = nsim,
                                         baseclin = baseclin,
                                         trtclin = trtclin,
                                         basesero = basesero,
                                         trtsero = trtsero,
                                         accrual = accrual,

                                         # immuno outcome control mean posterior
                                         i_c_mean = mean(df_res$i_post_prop_ctl, na.rm = T),
                                         i_c_sd = sd(df_res$i_post_prop_ctl, na.rm = T),
                                         i_t_mean = mean(df_res$i_post_prop_trt, na.rm = T),
                                         i_t_sd = sd(df_res$i_post_prop_trt, na.rm = T),

                                         # clinical outcome control mean posterior
                                         c_c_mean = mean(log(2)/df_res$c_post_lambda_ctl, na.rm = T),
                                         c_c_sd = sd(log(2)/df_res$c_post_lambda_ctl, na.rm = T),
                                         c_c_mean = mean(log(2)/df_res$c_post_lambda_trt, na.rm = T),
                                         c_c_sd = sd(log(2)/df_res$c_post_lambda_trt, na.rm = T),

                                         pct_fut = pct_fut,
                                         pct_fut_i = pct_fut_i,
                                         ss_fut_mean = as.numeric(ss_fut_stats[1]),
                                         ss_fut_sd = as.numeric(ss_fut_stats[2]),
                                         ss_fut_med = as.numeric(ss_fut_stats[3]),
                                         pct_sup = pct_sup,
                                         ss_sup_mean = as.numeric(ss_sup_stats[1]),
                                         ss_sup_sd = as.numeric(ss_sup_stats[2]),
                                         ss_sup_med = as.numeric(ss_sup_stats[3]),
                                         pct_stopv = pct_stopv,
                                         ss_stopv_mean = as.numeric(ss_stopv_stats[1]),
                                         ss_stopv_sd = as.numeric(ss_stopv_stats[2]),
                                         ss_stopv_med = as.numeric(ss_stopv_stats[3]),
                                       fname = fname, stringsAsFactors = F)

  df_all <- rbind(df_all,  dtmp, stringsAsFactors  = F)


}


# unique(df_all$idsim)
df_0 <- df_all %>%
  dplyr::filter(idsim == "Null01") %>%
  dplyr::arrange(-accrual, baseclin, basesero) %>%
  dplyr::mutate(row = 1:n()) %>%
  dplyr::select(row, everything())

df_sero1 <- df_all %>%
      dplyr::filter(idsim == "SeroTrt02") %>%
      dplyr::arrange(-accrual, baseclin, basesero)%>%
      dplyr::mutate(row = 1:n()) %>%
      dplyr::select(row, everything())

df_sero2 <- df_all %>%
  dplyr::filter(idsim == "SeroTrt01") %>%
  dplyr::arrange(-accrual, baseclin, basesero) %>%
  dplyr::mutate(row = 1:n()) %>%
  dplyr::select(row, everything())

df_clin1 <- df_all %>%
  dplyr::filter(idsim == "ClinTrt03") %>%
  dplyr::arrange(-accrual, baseclin, basesero) %>%
  dplyr::mutate(row = 1:n()) %>%
  dplyr::select(row, everything())


df_clin2 <- df_all %>%
  dplyr::filter(idsim == "ClinTrt02") %>%
  dplyr::arrange(-accrual, baseclin, basesero) %>%
  dplyr::mutate(row = 1:n()) %>%
  dplyr::select(row, everything())

df_clinsero1 <- df_all %>%
  dplyr::filter(idsim == "ClinSeroTrt01") %>%
  dplyr::arrange(-accrual, baseclin, trtclin, basesero) %>%
  dplyr::mutate(row = 1:n()) %>%
  dplyr::select(row, everything())

df_clinsero2 <- df_all %>%
  dplyr::filter(idsim == "ClinSeroTrt02") %>%
  dplyr::arrange(-accrual, baseclin, trtclin, basesero) %>%
  dplyr::mutate(row = 1:n()) %>%
  dplyr::select(row, everything())

df_clinsero3 <- df_all %>%
  dplyr::filter(idsim == "ClinSeroTrt03") %>%
  dplyr::arrange(-accrual, baseclin, trtclin, basesero) %>%
  dplyr::mutate(row = 1:n()) %>%
  dplyr::select(row, everything())


# df_2 <- df_all %>%
#   dplyr::filter(idsim == "ClinTrt01") %>%
#   dplyr::arrange(-accrual, baseclin, basesero)%>%
#   dplyr::mutate(row = 1:n()) %>%
#   dplyr::select(row, everything())



#df_2 <- df_all %>%
#  dplyr::filter(baseclin != trtclin & basesero == trtsero)
# rmarkdown::render("simulation_report.Rmd", clean=TRUE)
```



### Null Scenarios

These are primarily to assess type i error and sample size.

```{r, echo = F, eval = T}
digits <- c(0, 0, 0, 0, 2, 2, 0,
            3, 3, 3, 3,
            2, 2, 2, 2,
            3, 3, 1, 1, 1,
            3, 1, 1, 1,
            3, 1, 1, 1)
options(knitr.kable.NA = '-')
stopifnot(nrow(df_0) == 24)
kable(df_0 %>% dplyr::select(-idsim),
      caption = "Table 1. Simulation Null Scenarios",
      col.names = c("","nsims", "base", "trt", "base", "trt", "accrual",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "%", "immu_%", "mean", "sd", "med",
                    "%","mean", "sd", "med",
                    "%","mean", "sd", "med", "file"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11) %>%
  add_header_above(c(" " = 1, " " = 1,
                     "Clinical" = 2, "Seroconversion" = 2, " " = 1,
                     "Immu posterior" = 4,
                     "Clin posterior" = 4,
                     "Futility (%, sampsize)" = 5,
                     "Superiority (%, sampsize)" = 4,
                     "Stop V Samp (%, sampsize)" = 4,
                   " " = 1))

```

### Immunological effect scenarios

These look at a number of treatment effects in seroconversion for a range of clinical and accrual parameters.

```{r, echo = F}
stopifnot(nrow(df_sero1) == 24)
kable(df_sero1 %>% dplyr::select(-idsim),
      caption = "Table 2. Immunological effect scenario 1",
      col.names = c("","nsims", "base", "trt", "base", "trt", "accrual",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "%","immu_%", "mean", "sd", "med",
                    "%","mean", "sd", "med",
                    "%","mean", "sd", "med", "file"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11) %>%
  add_header_above(c(" " = 1, " " = 1,
                     "Clinical" = 2, "Seroconversion" = 2, " " = 1,
                     "Immu posterior" = 4,
                     "Clin posterior" = 4,
                     "Futility (%, sampsize)" = 5,
                     "Superiority (%, sampsize)" = 4,
                     "Stop V Samp (%, sampsize)" = 4,
                   " " = 1))

```



```{r, echo = F}
stopifnot(nrow(df_sero2) == 24)
kable(df_sero2 %>% dplyr::select(-idsim),
      caption = "Table 3. Immunological effect scenario 2",
      col.names = c("","nsims", "base", "trt", "base", "trt", "accrual",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "%","immu_%", "mean", "sd", "med",
                    "%","mean", "sd", "med",
                    "%","mean", "sd", "med", "file"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11) %>%
  add_header_above(c(" " = 1, " " = 1,
                     "Clinical" = 2, "Seroconversion" = 2, " " = 1,
                     "Immu posterior" = 4,
                     "Clin posterior" = 4,
                     "Futility (%, sampsize)" = 5,
                     "Superiority (%, sampsize)" = 4,
                     "Stop V Samp (%, sampsize)" = 4,
                   " " = 1))
```


### Clinical effect scenarios

These look at a number of treatment effects in clinical outcome for a range of seroconversion and accrual parameters.

```{r, echo = F}
stopifnot(nrow(df_clin1) == 24)
kable(df_clin1 %>% dplyr::select(-idsim),
      caption = "Table 4. Clinical effect scenario 1",
      col.names = c("","nsims", "base", "trt", "base", "trt", "accrual",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "%","immu_%", "mean", "sd", "med",
                    "%","mean", "sd", "med",
                    "%","mean", "sd", "med", "file"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11) %>%
  add_header_above(c(" " = 1, " " = 1,
                     "Clinical" = 2, "Seroconversion" = 2, " " = 1,
                     "Immu posterior" = 4,
                     "Clin posterior" = 4,
                     "Futility (%, sampsize)" = 5,
                     "Superiority (%, sampsize)" = 4,
                     "Stop V Samp (%, sampsize)" = 4,
                   " " = 1))

```


```{r, echo = F}
stopifnot(nrow(df_clin2) == 24)
kable(df_clin2 %>% dplyr::select(-idsim),
      caption = "Table 4. Clinical effect scenario 1",
      col.names = c("","nsims", "base", "trt", "base", "trt", "accrual",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "%","immu_%", "mean", "sd", "med",
                    "%","mean", "sd", "med",
                    "%","mean", "sd", "med", "file"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11) %>%
  add_header_above(c(" " = 1, " " = 1,
                     "Clinical" = 2, "Seroconversion" = 2, " " = 1,
                     "Immu posterior" = 4,
                     "Clin posterior" = 4,
                     "Futility (%, sampsize)" = 5,
                     "Superiority (%, sampsize)" = 4,
                     "Stop V Samp (%, sampsize)" = 4,
                   " " = 1))

```


### Combined effect scenarios

These look at combined treatment effects for immunological and clinical outcomes.

```{r, echo = F}
stopifnot(nrow(df_clinsero1) == 24)
kable(df_clinsero1 %>% dplyr::select(-idsim),
      caption = "Table 5. Combined effect scenario 1",
      col.names = c("","nsims", "base", "trt", "base", "trt", "accrual",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "%","immu_%", "mean", "sd", "med",
                    "%","mean", "sd", "med",
                    "%","mean", "sd", "med", "file"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11) %>%
  add_header_above(c(" " = 1, " " = 1,
                     "Clinical" = 2, "Seroconversion" = 2, " " = 1,
                     "Immu posterior" = 4,
                     "Clin posterior" = 4,
                     "Futility (%, sampsize)" = 5,
                     "Superiority (%, sampsize)" = 4,
                     "Stop V Samp (%, sampsize)" = 4,
                   " " = 1))

```



```{r, echo = F}
stopifnot(nrow(df_clinsero2) == 24)
kable(df_clinsero2 %>% dplyr::select(-idsim),
      caption = "Table 6. Combined effect scenario 2",
      col.names = c("","nsims", "base", "trt", "base", "trt", "accrual",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "%","immu_%", "mean", "sd", "med",
                    "%","mean", "sd", "med",
                    "%","mean", "sd", "med", "file"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11) %>%
  add_header_above(c(" " = 1, " " = 1,
                     "Clinical" = 2, "Seroconversion" = 2, " " = 1,
                     "Immu posterior" = 4,
                     "Clin posterior" = 4,
                     "Futility (%, sampsize)" = 5,
                     "Superiority (%, sampsize)" = 4,
                     "Stop V Samp (%, sampsize)" = 4,
                   " " = 1))

```




```{r, echo = F}
stopifnot(nrow(df_clinsero3) == 24)
kable(df_clinsero3 %>% dplyr::select(-idsim),
      caption = "Table 7. Combined effect scenario 3",
      col.names = c("","nsims", "base", "trt", "base", "trt", "accrual",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "%","immu_%", "mean", "sd", "med",
                    "%","mean", "sd", "med",
                    "%","mean", "sd", "med", "file"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11) %>%
  add_header_above(c(" " = 1, " " = 1,
                     "Clinical" = 2, "Seroconversion" = 2, " " = 1,
                     "Immu posterior" = 4,
                     "Clin posterior" = 4,
                     "Futility (%, sampsize)" = 5,
                     "Superiority (%, sampsize)" = 4,
                     "Stop V Samp (%, sampsize)" = 4,
                   " " = 1))

```


```{r, echo = F, fig.height=8, fig.width=12}
df_tmp <- df_clinsero1
df_tmp$accrual <- as.factor(df_tmp$accrual)
p1 <- ggplot(df_tmp, aes(x = baseclin, y = 100*pct_fut, 
                         colour = accrual))+
              geom_point() +
  geom_line() +
  scale_colour_discrete(name = "Accrual per interim") +
  scale_x_continuous("Control arm median time to event") +
  scale_y_continuous("% futility", limits = c(0, 75)) +
  facet_grid(paste0("seroconversion control ", basesero) ~ paste0("sero trt ", trtsero))+
  theme(legend.position="top")

p2 <- ggplot(df_tmp, aes(x = baseclin, y = 100*pct_sup, colour = accrual))+
              geom_point() +
  geom_line() +
  scale_colour_discrete(name = "Accrual per interim") +
  scale_x_continuous("Control arm median time to event") +
  scale_y_continuous("% superiority", limits = c(25, 100)) +
  facet_grid(paste0("seroconversion control ", basesero) ~ paste0("sero trt ", trtsero))+
  theme(legend.position="top")

p3 <- ggplot(df_tmp, aes(x = baseclin, y = 100*pct_stopv, colour = accrual))+
              geom_point() +
  geom_line() +
  scale_colour_discrete(name = "Accrual per interim") +
  scale_x_continuous("Control arm median time to event") +
  scale_y_continuous("% cease venous", limits = c(50, 100)) +
  facet_grid(paste0("seroconversion control ", basesero) ~ paste0("sero trt ", trtsero))+
  theme(legend.position="top")

# gridExtra::grid.arrange(p1, p2, p3, ncol = 3,
#              top = grid::textGrob("Figure 1. Power as a function of simulation params",
#                             x = 0, y = 0.5,
#                             just = "left",
#                             gp = grid::gpar(fontsize = 12)))
```


## Conclusions






