---
title: "Simulation Results"
output:
  html_document:
    toc: true
    theme: united
    classoption: landscape
    self_contained: no
  geometry: margin=0cm
  pdf_document:
    toc: yes
    toc_depth: 3
    number_sections: true
    fig_caption: yes
editor_options:
  chunk_output_type: console
classoption: landscape  
---

<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path = 'figs/')
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(kableExtra))
suppressPackageStartupMessages(library(psych))
suppressPackageStartupMessages(library(grid))
suppressPackageStartupMessages(library(gridExtra))
source("util.R")


getsum <- function(x){
  mysummary <- data.frame(NA_real_, NA_character_, NA_real_, NA_real_,
                NA_real_, NA_real_,  NA_real_,  as.numeric(1),
                mean(x$i_c_mean), mean(x$i_c_sd),  mean(x$i_t_mean),
                mean(x$i_t_sd), mean(x$c_c_mean), mean(x$c_c_sd),
                mean(x$c_c_mean), mean(x$c_c_sd),
                geometric.mean(x$pct_fut), mean(x$ss_fut_mean),
                mean(x$ss_fut_sd), mean(x$ss_fut_med),
                geometric.mean(x$pct_sup), mean(x$ss_sup_mean),
                mean(x$ss_sup_sd),  mean(x$ss_sup_med),
                geometric.mean(x$pct_stopv),  mean(x$ss_stopv_mean),
                mean(x$ss_stopv_sd), mean(x$ss_stopv_med), NA_character_,
                stringsAsFactors = F)
    row.names(mysummary) <- NULL
    names(mysummary) <- names(x)
    mysummary
}


ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text = element_text(size = 10))
ggplot2::theme_update(axis.text.x = element_text(size = 10))
ggplot2::theme_update(axis.text.y = element_text(size = 10))

# Work|Right|Fast
# rmarkdown::render("simulation_report.Rmd", clean=TRUE)
```



## Data generation processes

We simulate 1000 trial by generating data as follows:

+ equal numbers of participants in the control and treatment arms accrued sequentially (treatment, control, treatment, control...etc)
+ age of participants based on a truncated normal distribution with the lower and upper bounds set to 6 and 12 respectively with a mean of 6.5 months and a standard deviation of 1 month (used to assess censoring in the time to event analyses)
+ accrual time (time of randomisation) is set sequentially for each participant. Specifically the accrual times for participants $1, 2, 3, \dots, n$ are set to $0, t, 2t, 3t, \dots, (n-1)t$ where $t$ is the time required to accrue a participant
+ for each individual, baseline seroconversion status is generated as a bernoulli random draw parameterised with $p$ equal to the baseline seroconversion probability and $n$ is the $n^{th}$ participant
+ seroconversion status after the third dose/placebo is generated in the same fashion conditional on treatment status, baseline seroconversion status and treatment arm probability of seroconversion
+ time to event times are generated as draws from an exponential distribtion with rate parameter set conditional on treatment group status. Censoring occurs due to age at interim and events that are unobserved at the current interim time.

## Seroconversion modelling

The seroconversion model uses a beta conjugate prior to the bernoulli likelihood. The prior is uniform, i.e. $Beta(1, 1)$, i.e. uninformative. On the basis of the number of seroconversions in each arm and the number of observed individuals at the interim, we compute the posterior distribution for the parameter of interest (probability of a successful trial, $p$). We do this for the control and treatment arms independently, yielding posteriors for $p_{trt}$ and $p_{ctl}$. The difference between these two is approximately normal so we could assess the difference on that basis. However, instead we just look at the proportion of times (out of our posterior draws) that the difference between the two posterior draws is greater than zero. This proportion is an empirical probability and if it is in excess of the some nominated threshold (see section thresholds below) we claim that the immunological endpoint is successful and cease further venous sampling.

Now, we have a posterior for $p_{ij}$ $i = 1..n_{post}$ where $n_{post}$ is number of posterior draws we sampled and $j = 0, 1$ is an indicator of treatment group. Thus, we can impute the currently unobserved results for seroconversion up to the maximum possible number of venous samples. We can do this directly from a beta-binomial distribution, or, we can iterate through the posterior draws $p_i$ and generate random draws from a bernoulli distribution parameterised with our current value of $p$. We do the latter making as many simulated data sets as we wish.

Next, assuming we have generated $n$ data sets corresponding to the combination of currently observed values for seroconversion status and those that we imputed, we can (once again) compute the posterior of our paramater of interest in each case. Again, we can look at the posterior of the parameter of interest and again we can deterime an empirical probability that it is in excess of some nominated threshold. We do this for ALL $n$ of the imputed datasets. The proportion of these in which a successful trial was observed is compared to a futility threshold, say 5% (see below). If the proportion of successful trials is less than this threshold, we say the trial is futile and cease enrollment.

Note - we stop venous sampling at 250 participants.

## Medical attendance modelling

Note - we do not start modelling medical attendance until we have 250 participants. If we start this from 50 then we are going to get ridiculous results because we will see no events.

Conceptually, the approach is similar to the one adopted for modelling seroconversion. Obviously the modelling assumptions are somewhat different and censoring is also involved. Let's talk about censoring first.

At each interim we have an increasing number of participants. Each will have been accrued at a certain time and will have an age somewhere between 6 and 12 months at the time of accrual/ranomdisation. Knowing the month of the interim, the accrual time and the age at which they were accrued, we can compute the age at the current interim. If the sum of a participants age and their time to event (see later) is in excess of 36 months (max. follow up time) they are censored with censoring time equal to 36 months. Additionally, if the sum of a participants time to event and the accrual time is in excess of the interim then they are censored. The censoring time is the minimum of the 36 months and the difference between the current interim and the time of accrual.

The time to event model uses a gamma conjugate prior to the exponential likelihood and essentially everything is as per the seroconversion model. We compute the posterior for the parameter of interest (a rate parameter $\gamma$ to the exponential distribution) and generate imputed datasets for the participants that were yet to be observed up to the maximum sample size. For superiority we examine the ratio of the rate parameters which is proportional to the ratio of median survival time and compare this ratio to 1. For futility we do the equivalent, but on numerous hypothetical data we generated based on our current knowledge of the posterior.

## Decision rules and thresholds

The key points are that (1) the trial may be stopped due to futility based on an assessment of either endpoint (2) the trial may be stopped for superiority solely on the basis of an assessment of the clinical endpoint and (3) venous sampling can be stopped based on an assessment of the immunological endpoint.

+ To declare superiority in the immunological endpoint (and cease venous sampling but continue enrolling for the clinical endpoint) we require $Pr(\delta >0) > 0.975$ where $\delta = p_{trt} - p_{ctl}$. If delta is the distribution of the differences between the proportions in each arm, then we require that the probability that the difference is in excess of zero be greater than 0.975.

+ To declare futility in the immunological endpoint we require $\frac{1}{k}\sum_{i=1}^{n_{post}}I(Pr(\delta >0)>0.975) < 0.05$. In other words, if less than 5% of our simulated datasets result in a successful trial we declare futility.

+ To declare superiority in the clinical endpoint (and therefore in the trial) we require $Pr(\delta >0) > 0.975$ where $\delta = p_{trt} - p_{ctl}$. In other words, if delta is the difference in the proportion of seroconverted participants. Then we require that the probability that this difference is in excess of zero be greater than 0.975.

+ To declare futility in the clinical endpoint require $\frac{1}{k}\sum_{i=1}^{n_{post}}I(Pr(\delta >0)>0.975) < 0.05$. In other words, if less than 5% of our simulated datasets result in a successful trial we declare futility.

## Nuance/Limitations

The number of individuals is constrained to a maximum of 1000. We assume that funds are available to continue the experiment up to this point regardless of the accrual rate. However, this may not be realistic.

Based on the above rules we can claim superiority in the immunological endpoint, cease venous sampling, but continue enrolling for the clinical endpoint. Therefore we can conceivably conclude futility in the clinical endpoint in the same simulated trial. This may or may not be desirable.

Delays in information (i.e. in obtaining the blood results) are not currenly implemented.

The type i and type ii errors need to be balanced. We might be unwilling to risk incorrectly rejecting the null hypothesis at the 5% significance level. However, decreasing the type i error implicitly increases the type ii error (and therefore reduces power) when the alternative hypothesis is true. Thus if the type i error is really low and the power is not quite where we want it to be then we can trade these two thresholds off against one another to try and improve the overall operating characteristics.

![Figure 1](figs/typei_tpyeii.png "Figure 1")

The models are based on conjugate priors -- I tried many other ways, including writing samplers in C++ and approximations. In the actual analysis we will use generalised linear models (logistic regression) and piecewise exponential survival models both estimated with MCMC. These models will likely include additional covariates but the decision process will remain the same. I am worried that the necessary simulations (i.e. for the real analyses) will take way to long, but will cross that bridge when we come to it. See the SAP for further detail.

## Results from simulation scenarios

The following tables and plots summarise the scenarios that were simulated. We use the thresholds mentioned above.

### Summary of results

**Todo**

add create logs, out and dbg directory.

should report the difference for clin and immu along with the uncertainty/95% percentiles.

i need to update code + tables to also present the pct futility results for the clinical arm - can do this by making the decision based on a boolean and.

need to add look at which futility/super/stop v occurred

introduce a really really high threshold for the posterior decision on immunological (latter will be more palatable)

look up bias and precision - pdt

check choice of parameterisation
https://www.johndcook.com/blog/conjugate_prior_diagram/#exponential


**Null Scenarios**

Difference - bias and precision.

Across the range of true parameters and accrual rates used to generate the data, trials are indicated as futile > 95% of the time. In the majority of cases, the futility decision is due to  seroconversion. However, note that this is just an artefact of the current implementation arising due to the fact that the seroconversion analysis is run first. It is likely that the medical endpoint would be indicated as futile as well.

The sample size at which futility is announced is typcially around 100 participants at interim 2 or 3 (dependent on accrual rate). Superiority is indicated less than 2.5% of the time. Venous sampling is stopped around 10-15% of the time but venous sampling, but this needs to be considered in the context of the fact that most trials are identified as futile.

**Immunological effect**

Difference - bias and precision.

Futility is still high - try to fix by using immuno endpoint.





### Reading the tables

Reading the header from left to right, the tables each show a simulation id, the number of simulations ran, along with the clinical and immunological parameters used to generate the data. Accrual represents the number of participants randomised in each three month period between interim analyses. Next shown are the immunological and clinical estimates of the parameters (means and sd) for each arm.  The futility, superiority and stop venous sampling fields show (1) the percentage of the simulations where the trial was stopped for futility, the percentage of the futile trials due to an assessment of the immunological endpoint followed by the mean sample size, the standard deviation and the median sample size (2) the percentage of the simulations where the trial was stopped for superiority along with sample size metrics and (3) the percentage of times that venous sample was stopped along with sample size metrics. Finally, the filename of the source data is presented.

```{r, echo = F}
resfiles <- list.files("out", pattern = "*.RDS")

df_all <- data.frame(stringsAsFactors = F)
for(fname in resfiles){
  d1 <- readRDS(file.path(getwd(), "out", fname))
  # d1 <- readRDS(file.path(getwd(), "out", resfiles[1]))
  df_res <- as.data.frame(d1$results)

  nsim <- d1$cfg$nsims
  # true values for median surv (mnth)
  baseclin <- med_surv(d1$cfg$b0tte)
  trtclin <- med_surv(d1$cfg$b0tte + d1$cfg$b1tte)
  # true values for seroconversion prob
  basesero <- d1$cfg$baselineprobsero
  trtsero <- d1$cfg$trtprobsero
  # accrual
  accrual <- d1$cfg$people_per_interim_period
  info_delay <- d1$cfg$sero_info_delay
  
  outcome_labs <- c("Futile", "Superior", "Inconclusive")
  df_res$trial_outcome <- NA
  df_res$trial_outcome <- ifelse(df_res$stop_i_fut == 1 | df_res$stop_c_fut == 1, 1, df_res$trial_outcome)
  df_res$trial_outcome <- ifelse(df_res$stop_c_sup == 1, 2, df_res$trial_outcome)
  df_res$trial_outcome <- ifelse(df_res$inconclusive == 1, 3, df_res$trial_outcome)
  
  df_res$trial_outcome <- factor(df_res$trial_outcome, levels = 1:3, labels = outcome_labs)

  # df_res$trial_outcome <- ifelse(stop_v_samp == 1, 3, df_res$trial_outcome)

  # trials are either futile or superior 
  df_outcome <- df_res %>%
    dplyr::filter(trial_outcome %in% c("Futile", "Superior", "Inconclusive") )
    
  df_stopv <- df_res %>%
    dplyr::filter(stop_v_samp == 1) 
  
  n <- c(table(df_res$trial_outcome),   nrow(df_stopv))
  prob <- c(prop.table(table(df_res$trial_outcome)),   nrow(df_stopv)/max(df_res$idxsim))
  names(prob) <- c(names(prob)[1:3], "StopV")
  
  df_ss <- df_outcome %>% 
    dplyr::group_by(trial_outcome) %>%
    dplyr::summarise(ss_mean = mean(n_obs), 
                     ss_sd = sd(n_obs)) %>%
    tidyr::complete(trial_outcome, fill = list(ss_mean = 0))
  
  

  dtmp <- data.frame(idsim = d1$cfg$idsim,
                     nsim = nsim,

                     basesero = basesero,
                     trtsero = trtsero,
                     baseclin = baseclin,
                     trtclin = trtclin,
                     accrual = accrual,
                     info_delay = info_delay,
                     
                     
                     prob_sup = prob["Superior"],
                     prob_fut = prob["Futile"],
                     prob_incon = prob["Inconclusive"],
                     prob_stopv = prob["StopV"],
                     
                     n_sup = n[2],
                     n_fut = n[1],
                     n_incon = n[3],
                     n_stopv = n[4],
                                         
                     ss_fut_mean = unlist(df_ss[df_ss$trial_outcome == "Futile", "ss_mean"]), 
                     ss_fut_sd = unlist(df_ss[df_ss$trial_outcome == "Futile", "ss_sd"]), 
                     
                     ss_sup_mean = unlist(df_ss[df_ss$trial_outcome == "Superior", "ss_mean"]), 
                     ss_sup_sd = unlist(df_ss[df_ss$trial_outcome == "Superior", "ss_sd"]), 
                    
                     ss_incon_mean = unlist(df_ss[df_ss$trial_outcome == "Inconclusive", "ss_mean"]), 
                     ss_incon_sd = unlist(df_ss[df_ss$trial_outcome == "Inconclusive", "ss_sd"]), 
                     
                     ss_stopv_mean = mean(df_stopv$n_obs),
                     ss_stopv_sd = sd(df_stopv$n_obs),

                     fname = fname, stringsAsFactors = F)
  
  dtmp <- dtmp %>%
    dplyr::mutate(f_prob_sup = sprintf("%.2f (%d)", prob_sup, n_sup),
                  f_prob_fut = sprintf("%.2f (%d)", prob_fut, n_fut),
                  f_prob_incon = sprintf("%.2f (%d)", prob_incon, n_incon),
                  f_prob_stopv = sprintf("%.2f (%d)", prob_stopv, n_stopv),
                  
                  f_ss_sup = sprintf("%.1f (%.1f)", ss_sup_mean, ss_sup_sd),
                  f_ss_fut = sprintf("%.1f (%.1f)", ss_fut_mean, ss_fut_sd),
                  f_ss_incon = sprintf("%.1f (%.1f)", ss_incon_mean, ss_incon_sd),
                  f_ss_stopv = sprintf("%.1f (%.1f)", ss_stopv_mean, ss_stopv_sd) )
  

  

  df_all <- rbind(df_all,  dtmp, stringsAsFactors  = F)

}


# unique(df_all$idsim)
df_0 <- df_all %>%
  dplyr::arrange(-accrual, baseclin, basesero) %>%
  dplyr::mutate(row = 1:n()) %>%
  dplyr::select(row, nsim, 
                basesero, trtsero, baseclin, trtclin, accrual,info_delay,
                f_prob_sup, f_prob_fut, f_prob_incon, f_prob_stopv, 
                f_ss_sup, f_ss_fut, f_ss_incon, f_ss_stopv,
                fname)

# 
# df_sero1 <- df_all %>%
#       dplyr::filter(idsim == "SeroTrt02") %>%
#       dplyr::arrange(-accrual, baseclin, basesero)%>%
#       dplyr::mutate(row = 1:n()) %>%
#       dplyr::select(row, everything())
# 
# df_sero2 <- df_all %>%
#   dplyr::filter(idsim == "SeroTrt01") %>%
#   dplyr::arrange(-accrual, baseclin, basesero) %>%
#   dplyr::mutate(row = 1:n()) %>%
#   dplyr::select(row, everything())
# 
# df_clin1 <- df_all %>%
#   dplyr::filter(idsim == "ClinTrt03") %>%
#   dplyr::arrange(-accrual, baseclin, basesero) %>%
#   dplyr::mutate(row = 1:n()) %>%
#   dplyr::select(row, everything())
# 
# 
# df_clin2 <- df_all %>%
#   dplyr::filter(idsim == "ClinTrt02") %>%
#   dplyr::arrange(-accrual, baseclin, basesero) %>%
#   dplyr::mutate(row = 1:n()) %>%
#   dplyr::select(row, everything())
# 
# df_clinsero1 <- df_all %>%
#   dplyr::filter(idsim == "ClinSeroTrt01") %>%
#   dplyr::arrange(-accrual, baseclin, trtclin, basesero) %>%
#   dplyr::mutate(row = 1:n()) %>%
#   dplyr::select(row, everything())
# 
# df_clinsero2 <- df_all %>%
#   dplyr::filter(idsim == "ClinSeroTrt02") %>%
#   dplyr::arrange(-accrual, baseclin, trtclin, basesero) %>%
#   dplyr::mutate(row = 1:n()) %>%
#   dplyr::select(row, everything())
# 
# df_clinsero3 <- df_all %>%
#   dplyr::filter(idsim == "ClinSeroTrt03") %>%
#   dplyr::arrange(-accrual, baseclin, trtclin, basesero) %>%
#   dplyr::mutate(row = 1:n()) %>%
#   dplyr::select(row, everything())


# df_2 <- df_all %>%
#   dplyr::filter(idsim == "ClinTrt01") %>%
#   dplyr::arrange(-accrual, baseclin, basesero)%>%
#   dplyr::mutate(row = 1:n()) %>%
#   dplyr::select(row, everything())



#df_2 <- df_all %>%
#  dplyr::filter(baseclin != trtclin & basesero == trtsero)
# rmarkdown::render("simulation_report.Rmd", clean=TRUE)
```



### Null Scenarios

These are primarily to assess type i error and sample size.

Across theVenous sampling

```{r, echo = F, eval = T}
digits <- c(0, 0, 
            2, 2, 0, 0, 0, 2,
            0, 0, 0, 0,
            0, 0, 0, 0,
            0)
options(knitr.kable.NA = '-')
#stopifnot(nrow(df_0) == 24)
kable(df_0 ,
      caption = "Table 1. Simulation Null Scenarios",
      col.names = c("","nsims", 
                    "base", "trt", "base", "trt", "accrual", "info delay",
                    "superiority", "futility", "inconclusive", "stop v samp",
                    "superiority", "futility", "inconclusive", "stop v samp",
                    "file"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11) %>%
  add_header_above(c(" " = 1, " " = 1,
                     "Seroconversion" = 2, "Clinical" = 2,
                     " " = 1, " " = 1,
                     "Probability (number of trials)" = 4,
                     "Mean sample size (sd)" = 4,
                   " " = 1))

```


##


### Immunological effect scenarios

These look at a number of treatment effects in seroconversion for a range of clinical and accrual parameters.

```{r, echo = F}

if(exists("df_sero1")){
  stopifnot(nrow(df_sero1) == 24)
kable(df_sero1 %>% dplyr::select(-idsim),
      caption = "Table 2. Immunological effect scenario 1",
      col.names = c("","nsims", "base", "trt", "base", "trt", "accrual",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "%","immu_%", "mean", "sd", "med",
                    "%","mean", "sd", "med",
                    "%","mean", "sd", "med", "file"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11) %>%
  add_header_above(c(" " = 1, " " = 1,
                      "Seroconversion" = 2, "Clinical" = 2,
                     " " = 1,
                     "Immu posterior" = 4,
                     "Clin posterior" = 4,
                     "Futility (%, sampsize)" = 5,
                     "Superiority (%, sampsize)" = 4,
                     "Stop V Samp (%, sampsize)" = 4,
                   " " = 1))
}


```



```{r, echo = F}
if(exists("df_sero2")){
stopifnot(nrow(df_sero2) == 24)
kable(df_sero2 %>% dplyr::select(-idsim),
      caption = "Table 3. Immunological effect scenario 2",
      col.names = c("","nsims", "base", "trt", "base", "trt", "accrual",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "%","immu_%", "mean", "sd", "med",
                    "%","mean", "sd", "med",
                    "%","mean", "sd", "med", "file"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11) %>%
  add_header_above(c(" " = 1, " " = 1,
                      "Seroconversion" = 2, "Clinical" = 2,
                     " " = 1,
                     "Immu posterior" = 4,
                     "Clin posterior" = 4,
                     "Futility (%, sampsize)" = 5,
                     "Superiority (%, sampsize)" = 4,
                     "Stop V Samp (%, sampsize)" = 4,
                   " " = 1))
}
```


### Clinical effect scenarios

These look at a number of treatment effects in clinical outcome for a range of seroconversion and accrual parameters.

```{r, echo = F}
if(exists("df_clin1")){
stopifnot(nrow(df_clin1) == 24)
kable(df_clin1 %>% dplyr::select(-idsim),
      caption = "Table 4. Clinical effect scenario 1",
      col.names = c("","nsims", "base", "trt", "base", "trt", "accrual",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "%","immu_%", "mean", "sd", "med",
                    "%","mean", "sd", "med",
                    "%","mean", "sd", "med", "file"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11) %>%
  add_header_above(c(" " = 1, " " = 1,
                      "Seroconversion" = 2, "Clinical" = 2,
                     " " = 1,
                     "Immu posterior" = 4,
                     "Clin posterior" = 4,
                     "Futility (%, sampsize)" = 5,
                     "Superiority (%, sampsize)" = 4,
                     "Stop V Samp (%, sampsize)" = 4,
                   " " = 1))
}

```


```{r, echo = F}
if(exists("df_clin2")){
stopifnot(nrow(df_clin2) == 24)
kable(df_clin2 %>% dplyr::select(-idsim),
      caption = "Table 4. Clinical effect scenario 1",
      col.names = c("","nsims", "base", "trt", "base", "trt", "accrual",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "%","immu_%", "mean", "sd", "med",
                    "%","mean", "sd", "med",
                    "%","mean", "sd", "med", "file"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11) %>%
  add_header_above(c(" " = 1, " " = 1,
                      "Seroconversion" = 2, "Clinical" = 2,
                     " " = 1,
                     "Immu posterior" = 4,
                     "Clin posterior" = 4,
                     "Futility (%, sampsize)" = 5,
                     "Superiority (%, sampsize)" = 4,
                     "Stop V Samp (%, sampsize)" = 4,
                   " " = 1))
}

```


### Combined effect scenarios

These look at combined treatment effects for immunological and clinical outcomes.

```{r, echo = F}
if(exists("df_clinsero1")){
stopifnot(nrow(df_clinsero1) == 24)
kable(df_clinsero1 %>% dplyr::select(-idsim),
      caption = "Table 5. Combined effect scenario 1",
      col.names = c("","nsims", "base", "trt", "base", "trt", "accrual",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "%","immu_%", "mean", "sd", "med",
                    "%","mean", "sd", "med",
                    "%","mean", "sd", "med", "file"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11) %>%
  add_header_above(c(" " = 1, " " = 1,
                      "Seroconversion" = 2, "Clinical" = 2,
                     " " = 1,
                     "Immu posterior" = 4,
                     "Clin posterior" = 4,
                     "Futility (%, sampsize)" = 5,
                     "Superiority (%, sampsize)" = 4,
                     "Stop V Samp (%, sampsize)" = 4,
                   " " = 1))
}
```



```{r, echo = F}
if(exists("df_clinsero2")){
stopifnot(nrow(df_clinsero2) == 24)
kable(df_clinsero2 %>% dplyr::select(-idsim),
      caption = "Table 6. Combined effect scenario 2",
      col.names = c("","nsims", "base", "trt", "base", "trt", "accrual",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "%","immu_%", "mean", "sd", "med",
                    "%","mean", "sd", "med",
                    "%","mean", "sd", "med", "file"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11) %>%
  add_header_above(c(" " = 1, " " = 1,
                      "Seroconversion" = 2, "Clinical" = 2,
                     " " = 1,
                     "Immu posterior" = 4,
                     "Clin posterior" = 4,
                     "Futility (%, sampsize)" = 5,
                     "Superiority (%, sampsize)" = 4,
                     "Stop V Samp (%, sampsize)" = 4,
                   " " = 1))
}

```




```{r, echo = F}
if(exists("df_clinsero3")){
stopifnot(nrow(df_clinsero3) == 24)
kable(df_clinsero3 %>% dplyr::select(-idsim),
      caption = "Table 7. Combined effect scenario 3",
      col.names = c("","nsims", "base", "trt", "base", "trt", "accrual",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "mean_ctl", "sd_ctl", "mean_trt", "sd_trt",
                    "%","immu_%", "mean", "sd", "med",
                    "%","mean", "sd", "med",
                    "%","mean", "sd", "med", "file"),
      digits = digits) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = F, position = "left",
                font_size = 11) %>%
  add_header_above(c(" " = 1, " " = 1,
                      "Seroconversion" = 2, "Clinical" = 2,
                     " " = 1,
                     "Immu posterior" = 4,
                     "Clin posterior" = 4,
                     "Futility (%, sampsize)" = 5,
                     "Superiority (%, sampsize)" = 4,
                     "Stop V Samp (%, sampsize)" = 4,
                   " " = 1))
}

```


```{r, echo = F, eval = F, fig.height=8, fig.width=12}
df_tmp <- df_clinsero1
df_tmp$accrual <- as.factor(df_tmp$accrual)
p1 <- ggplot(df_tmp, aes(x = baseclin, y = 100*pct_fut,
                         colour = accrual))+
              geom_point() +
  geom_line() +
  scale_colour_discrete(name = "Accrual per interim") +
  scale_x_continuous("Control arm median time to event") +
  scale_y_continuous("% futility", limits = c(0, 75)) +
  facet_grid(paste0("seroconversion control ", basesero) ~ paste0("sero trt ", trtsero))+
  theme(legend.position="top")

p2 <- ggplot(df_tmp, aes(x = baseclin, y = 100*pct_sup, colour = accrual))+
              geom_point() +
  geom_line() +
  scale_colour_discrete(name = "Accrual per interim") +
  scale_x_continuous("Control arm median time to event") +
  scale_y_continuous("% superiority", limits = c(25, 100)) +
  facet_grid(paste0("seroconversion control ", basesero) ~ paste0("sero trt ", trtsero))+
  theme(legend.position="top")

p3 <- ggplot(df_tmp, aes(x = baseclin, y = 100*pct_stopv, colour = accrual))+
              geom_point() +
  geom_line() +
  scale_colour_discrete(name = "Accrual per interim") +
  scale_x_continuous("Control arm median time to event") +
  scale_y_continuous("% cease venous", limits = c(50, 100)) +
  facet_grid(paste0("seroconversion control ", basesero) ~ paste0("sero trt ", trtsero))+
  theme(legend.position="top")

# gridExtra::grid.arrange(p1, p2, p3, ncol = 3,
#              top = grid::textGrob("Figure 1. Power as a function of simulation params",
#                             x = 0, y = 0.5,
#                             just = "left",
#                             gp = grid::gpar(fontsize = 12)))
```


## Conclusions
