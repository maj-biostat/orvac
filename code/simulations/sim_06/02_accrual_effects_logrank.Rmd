---
title: "Simulations to explore accrual rate influence on power/ppos"
subtitle: "Accrual and time to event endpoint"
author: "Mark Jones"
date: "`r Sys.time()`"
output:
  html_document:
    classoption: landscape
    css: style.css
    number_sections: yes
    self_contained: yes
    theme: united
  pdf_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 3
  word_document:
    toc: yes
    toc_depth: '3'
geometry: left=0.2cm,right=0.2cm,top=1cm,bottom=1cm
editor_options:
  chunk_output_type: console
classoption: landscape
---

<!--    toc: yes
    toc_float: true -->

<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path = 'figs/')
suppressPackageStartupMessages(library(simstudy))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(mcmc))
suppressPackageStartupMessages(library(survival))

ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text = element_text(size = 10))
ggplot2::theme_update(legend.position = "top")
# ggplot2::theme_update(legend.title = element_blank())
ggplot2::theme_update(axis.text.x = element_text(size = 10))
ggplot2::theme_update(axis.text.y = element_text(size = 10))

# Work|Right|Fast
# rmarkdown::render("simulation_report.Rmd", clean=TRUE)

# logit to p
inv_logit <- function(x){
  return(exp(x)/(1+exp(x)))
}
# p to logit
logit <- function(p){
  return(log(p/(1-p)))
}
prob_to_odd <- function(x){
  return(x/(1-x))
}
odd_to_prob <- function(x){
  return(x/(1+x))
}

```

# Preamble

Assume you have interims starting at $n_{min}$ then every $n$ patients up to a maximum sample size $N$. If you vary $n$per interim (the accrual rate) how does it effect power in a survival endpoint (exponential)? We initially assume 40% censoring (plausibly indicative of orvac).

# Generate Data

```{r}
trial_dat <- function(trialid, n, t0, delta, c_rate){
  t1 <- t0 + delta
  b0 <- log(2)/t0
  b1 <- log(2)/t1 - log(2)/t0

  d <- data.frame(trialid = trialid, id = 1:n)
  d$trt <- rep(0:1, len = n)
  d$y <- rexp(n, b0 + b1*d$trt)
  d$c <- 0
  if(c_rate != 0){
    d$c[sample(1:n, n*c_rate)] = 1
  }
  d$y <- ifelse(d$c == 1, 36, d$y)
  d
}

# 1000 trials each with interims def by interm_n
nsim <- 1000
# obs per trial
N <- 1000 
# med tte
t0 <- 30
# trt effect
delta <- 10
# censoring rate
c_rate <- 0.4
d <- lapply(1:nsim, trial_dat, N, t0, delta, c_rate)

head(d[[1]])
```

Compute when interim analyses happen.

```{r}
get_int <- function(n){
  nmin <- 200
  interm_n <- seq(nmin, N, by = n)
  if(max(interm_n)!=N){
    interm_n <- c(interm_n, N)
  } 
  interm_n
}
get_int(n = 30)
```

Simulation using logrank.

```{r}

fit <- function(current_n, trial_id){
  lm1 <- survdiff(Surv(y, 1-c) ~ trt, data=d[[trial_id]][1:current_n,])
  pchisq(lm1$chisq,df = 1, lower.tail = F)
}

sim <- function(trial_id, n_step){
  res <- unlist(lapply(get_int(n_step), fit, trial_id))
  any(p.adjust(res, method = "bonferroni") < 0.05)
}

# ppos
accrual_rates <- c(30, 40, 50)
ppos1 <- rep(0, length(accrual_rates))

for(i in 1:length(accrual_rates)){
  ppos1[i] <- mean(unlist(lapply(1:nsim, sim, accrual_rates[i])))
}



# ppos - no censoring
accrual_rates <- c(30, 40, 50)
c_rate <- 0
d <- lapply(1:nsim, trial_dat, N, t0, delta, c_rate)

ppos2 <- rep(0, length(accrual_rates))

for(i in 1:length(accrual_rates)){
  ppos2[i] <- mean(unlist(lapply(1:nsim, sim, accrual_rates[i])))
}

```

Plot (dashed has more censoring).

```{r}
plot(accrual_rates, ppos1, type = "l", ylim = c(0.4, 0.8))
plot(accrual_rates, ppos2, type = "l")
```

# Summary

For the given samplesize, with $n$ participants per interim and censoring rate indicative of ORVAC, PPOS (adjustment for multiple comparisons) increases as accrual increases. 





