---
title: "Simulations to explore accrual rate influence on power/ppos"
subtitle: "Accrual and time to event endpoint"
author: "Mark Jones"
date: "`r Sys.time()`"
output:
  html_document:
    classoption: landscape
    css: style.css
    number_sections: yes
    self_contained: yes
    theme: united
  pdf_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 3
  word_document:
    toc: yes
    toc_depth: '3'
geometry: left=0.2cm,right=0.2cm,top=1cm,bottom=1cm
editor_options:
  chunk_output_type: console
classoption: landscape
---

<!--    toc: yes
    toc_float: true -->

<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path = 'figs/')
suppressPackageStartupMessages(library(simstudy))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(mcmc))
suppressPackageStartupMessages(library(survival))

ggplot2::theme_set(ggplot2::theme_bw())
ggplot2::theme_update(text = element_text(size = 10))
ggplot2::theme_update(legend.position = "top")
# ggplot2::theme_update(legend.title = element_blank())
ggplot2::theme_update(axis.text.x = element_text(size = 10))
ggplot2::theme_update(axis.text.y = element_text(size = 10))

# Work|Right|Fast
# rmarkdown::render("simulation_report.Rmd", clean=TRUE)

# logit to p
inv_logit <- function(x){
  return(exp(x)/(1+exp(x)))
}
# p to logit
logit <- function(p){
  return(log(p/(1-p)))
}
prob_to_odd <- function(x){
  return(x/(1-x))
}
odd_to_prob <- function(x){
  return(x/(1+x))
}

```

# Preamble

Assume you have interims starting at $n_{min}$ then every $n$ patients up to a maximum sample size $N$. If you vary $n$per interim (the accrual rate) how does it effect power in a survival endpoint (exponential)? We initially assume 40% censoring (plausibly indicative of orvac).

# Simulate interims

Generate datasets.

```{r}
trial_dat <- function(trialid, n, t0, delta){
  t1 <- t0 + delta
  b0 <- log(2)/t0
  b1 <- log(2)/t1 - log(2)/t0

  d <- data.frame(trialid = trialid, id = 1:n)
  # complete balance 1:1
  d$trt <- rep(0:1, len = n)
  d$y <- rexp(n, b0 + b1*d$trt)
  d$c <- 0
  d$c <- ifelse(d$y > 30, 1, 0)
  d$e <- 1 - d$c
  # assume they were 6 months when they were randomised
  # therefore once the time gets above 30, they will be
  # censored
  d$y <- ifelse(d$c == 1, 30, d$y)
  d
}

# 1000 trials each with interims def by interm_n
nsim <- 1000
# obs per trial
N <- 1000 
# baseline med tte
t0 <- 35
# trt effect (months increase)
delta <- 10
# censoring at 36 months of age (assuming rand at 6 months)
d <- lapply(1:nsim, trial_dat, N, t0, delta)

head(d[[1]])
```

Compute sample sizes when interim analyses happen assuming a given accrual rate.

```{r}
get_int <- function(n){
  nmin <- 200
  interm_n <- seq(nmin, N, by = n)
  if(max(interm_n)!=N){
    interm_n <- c(interm_n, N)
  } 
  interm_n
}
# e.g.
get_int(n = 30)
```

Simulation using logrank.

```{r}

fit <- function(current_n, sim_id){
  # retrieve the observations 1 to the size of the current 
  # interim from the relevant trial dataset and run a 
  # logrank test
  lm1 <- survdiff(Surv(y, 1-c) ~ trt, data=d[[sim_id]][1:current_n,])
  pchisq(lm1$chisq,df = 1, lower.tail = F)
}

sim_interims <- function(sim_id, n_step){
  
  interims <- get_int(n_step)
  
  # at each interim do the analysis
  res <- unlist(lapply(interims, fit, sim_id))
  # if a difference is detected in any of the analyses (adjusting for
  # multiplicity) then return true (implies expected success)
  any(p.adjust(res, method = "bonferroni") < 0.05)
}

```

Do simulations.

```{r}
# set up params of interest
accrual_rates <- c(30, 40, 50)
t0 <- c(20, 35, 50)
deltas <- c(5, 7.5, 10, 12.5, 15)
nsim <- 10000

dres <- expand.grid(deltas, t0, accrual_rates)
names(dres) <- c("delta", "t0", "accrual_per_q")
dres$ppos <- 0

for(i in 1:length(accrual_rates)){
  
  for(j in 1:length(t0)){
    
    for(k in 1:length(deltas)){
      
      d <- lapply(1:nsim, trial_dat, N, t0[j], deltas[k])
      
      ppos <- mean(unlist(lapply(1:nsim, sim_interims, n_step = accrual_rates[i])))
      
      dres[dres$delta == deltas[k] & 
             dres$t0 == t0[j] &
             dres$accrual_per_q == accrual_rates[i], "ppos"] <- ppos
      
    }

  }

}


```

Plot.

```{r, echo = F, fig.width=5, fig.height=5}
ggplot(dres, aes(x = delta, y = ppos, 
                 lty = paste0(accrual_per_q),
                 col = paste0(t0)))+
  geom_line() +
  scale_color_discrete("Baseline med tte")+
  scale_linetype_discrete("Accrual per interim")+
  theme(legend.direction = "horizontal") +
  theme(legend.position = "bottom") +
  theme(legend.box = "vertical")+
  scale_y_continuous("Pr(e.s)", lim = c(0, 1))+
  scale_x_continuous("Diff in med surv tim")
```

# Summary

For the given samplesize, with $n$ participants per interim and censoring rate indicative of ORVAC, PPOS (adjustment for multiple comparisons) increases as accrual increases. 





